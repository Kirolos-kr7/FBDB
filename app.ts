import { createReadStream } from "fs";
import { mapSync, split } from "event-stream";
import mongoose from "mongoose";
import usersModel from "./users.model";

// Your db connection string here
const dbUri = "mongodb+srv://kiroloskr7:k123456@fbdb.acjsnbr.mongodb.net/fbdb";
let counter = 0;

const storeFile = async (path: string) => {
  const fileName = path.replace("EG", "").replace(".txt", "");

  const s = createReadStream("./txt/" + path)
    .pipe(split())
    .pipe(
      mapSync(async (line: string) => {
        s.pause();

        let fields = line.split(",");
        fields = fields.map((x) => x.replaceAll('"', ""));

        const [
          _id,
          ,
          ,
          tel,
          ,
          ,
          first_name,
          last_name,
          gender,
          link,
          ,
          ,
          ,
          ,
          works_at,
          ,
          from,
          lives_in,
          studied_at,
          ,
          ,
          ,
          ,
          ,
          ,
          relationship_status,
        ] = fields;

        const user = {
          _id,
          tel,
          first_name,
          last_name,
          gender,
          link,
          works_at,
          studied_at,
          lives_in,
          from,
          relationship_status,
        };

        await usersModel
          .create(user)
          .then(() =>
            console.log(`[✔] - Adding user with id: ${user._id}. (${fileName})`)
          )
          .catch((err) => {
            if (err.code == 11000)
              console.log(`[✖] - User Already Exists. (${fileName})`);
            else console.log(err);
          })
          .finally(() => s.resume());
      })
    )
    .on("error", function (err) {
      console.log("Error while reading file.", err);
    })
    .on("end", function () {
      console.log("Read entire file.");
    });
};

const init = async () => {
  // Array of file paths
  const filePaths = [
    "EG1-000",
    "EG1-001",
    "EG1-002",
    "EG1-003",
    "EG1-004",
    "EG1-005",
    "EG1-006",
    "EG1-007",
    "EG1-008",
    "EG1-009",
    "EG1-010",
    "EG1-011",
    "EG1-012",
    "EG1-013",
    "EG1-014",
    "EG1-015",
    "EG1-016",
    "EG1-017",
    "EG1-018",
    "EG1-019",
    "EG1-020",
    "EG1-021",
    "EG1-022",
    "EG1-023",
    "EG1-024",
    "EG1-025",
    "EG1-026",
    "EG1-027",
    "EG1-028",
    "EG1-029",
    "EG1-030",
    "EG1-031",
    "EG1-032",
    "EG1-033",
    "EG1-034",
    "EG1-035",
    "EG1-036",
    "EG1-037",
    "EG1-038",
    "EG1-039",
    "EG1-040",
    "EG1-041",
    "EG1-042",
    "EG1-043",
    "EG1-044",
    "EG1-045",
    "EG1-046",
    "EG1-047",
    "EG1-048",
    "EG1-049",
    "EG1-050",
    "EG1-051",
    "EG1-052",
    "EG1-053",
    "EG1-054",
    "EG1-055",
    "EG1-056",
    "EG1-057",
    "EG1-058",
    "EG1-059",
    "EG1-060",
    "EG1-061",
    "EG1-062",
    "EG1-063",
    "EG1-064",
    "EG1-065",
    "EG1-066",
    "EG1-067",
    "EG1-068",
    "EG1-069",
    "EG1-070",
    "EG1-071",
    "EG1-072",
    "EG1-073",
    "EG1-074",
    "EG1-075",
    "EG1-076",
    "EG1-077",
    "EG1-078",
    "EG1-079",
    "EG1-080",
    "EG1-081",
    "EG1-082",
    "EG1-083",
    "EG1-084",
    "EG1-085",
    "EG1-086",
    "EG1-087",
    "EG1-088",
    "EG1-089",
    "EG1-090",
    "EG1-091",
    "EG1-092",
    "EG1-093",
    "EG1-094",
    "EG1-095",
    "EG1-096",
    "EG1-097",
    "EG1-098",
    "EG1-099",
    "EG1-100",
    "EG1-101",
    "EG1-102",
    "EG1-103",
    "EG1-104",
    "EG1-105",
    "EG1-106",
    "EG1-107",
    "EG1-108",
    "EG1-109",
    "EG1-110",
    "EG1-111",
    "EG1-112",
    "EG2-000",
    "EG2-001",
    "EG2-002",
    "EG2-003",
    "EG2-004",
    "EG2-005",
    "EG2-006",
    "EG2-007",
    "EG2-008",
    "EG2-009",
    "EG2-010",
    "EG2-011",
    "EG2-012",
    "EG2-013",
    "EG2-014",
    "EG2-015",
    "EG2-016",
    "EG2-017",
    "EG2-018",
    "EG2-019",
    "EG2-020",
    "EG2-021",
    "EG2-022",
    "EG2-023",
    "EG2-024",
    "EG2-025",
    "EG2-026",
    "EG2-027",
    "EG2-028",
    "EG2-029",
    "EG2-030",
    "EG2-031",
    "EG2-032",
    "EG2-033",
    "EG2-034",
    "EG2-035",
    "EG2-036",
    "EG2-037",
    "EG2-038",
    "EG2-039",
    "EG2-040",
    "EG2-041",
    "EG2-042",
    "EG2-043",
    "EG2-044",
    "EG2-045",
    "EG2-046",
    "EG2-047",
    "EG2-048",
    "EG2-049",
    "EG2-050",
    "EG2-051",
    "EG2-052",
    "EG2-053",
    "EG2-054",
    "EG2-055",
    "EG2-056",
    "EG2-057",
    "EG2-058",
    "EG2-059",
    "EG2-060",
    "EG2-061",
    "EG2-062",
    "EG2-063",
    "EG2-064",
    "EG2-065",
    "EG2-066",
    "EG2-067",
    "EG2-068",
    "EG2-069",
    "EG2-070",
    "EG2-071",
    "EG2-072",
    "EG2-073",
    "EG2-074",
    "EG2-075",
    "EG2-076",
    "EG2-077",
    "EG2-078",
    "EG2-079",
    "EG2-080",
    "EG2-081",
    "EG2-082",
    "EG2-083",
    "EG2-084",
    "EG2-085",
    "EG2-086",
    "EG2-087",
    "EG2-088",
    "EG2-089",
    "EG2-090",
    "EG2-091",
    "EG2-092",
    "EG2-093",
    "EG2-094",
    "EG2-095",
    "EG2-096",
    "EG2-097",
    "EG2-098",
    "EG2-099",
    "EG2-100",
    "EG2-101",
    "EG2-102",
    "EG2-103",
    "EG2-104",
    "EG2-105",
    "EG2-106",
    "EG2-107",
    "EG2-108",
    "EG2-109",
    "EG2-110",
    "EG2-111",
    "EG2-112",
    "EG3-000",
    "EG3-001",
    "EG3-002",
    "EG3-003",
    "EG3-004",
    "EG3-005",
    "EG3-006",
    "EG3-007",
    "EG3-008",
    "EG3-009",
    "EG3-010",
    "EG3-011",
    "EG3-012",
    "EG3-013",
    "EG3-014",
    "EG3-015",
    "EG3-016",
    "EG3-017",
    "EG3-018",
    "EG3-019",
    "EG3-020",
    "EG3-021",
    "EG3-022",
    "EG3-023",
    "EG3-024",
    "EG3-025",
    "EG3-026",
    "EG3-027",
    "EG3-028",
    "EG3-029",
    "EG3-030",
    "EG3-031",
    "EG3-032",
    "EG3-033",
    "EG3-034",
    "EG3-035",
    "EG3-036",
    "EG3-037",
    "EG3-038",
    "EG3-039",
    "EG3-040",
    "EG3-041",
    "EG3-042",
    "EG3-043",
    "EG3-044",
    "EG3-045",
    "EG3-046",
    "EG3-047",
    "EG3-048",
    "EG3-049",
    "EG3-050",
    "EG3-051",
    "EG3-052",
    "EG3-053",
    "EG3-054",
    "EG3-055",
    "EG3-056",
    "EG3-057",
    "EG3-058",
    "EG3-059",
    "EG3-060",
    "EG3-061",
    "EG3-062",
    "EG3-063",
    "EG3-064",
    "EG3-065",
    "EG3-066",
    "EG3-067",
    "EG3-068",
    "EG3-069",
    "EG3-070",
    "EG3-071",
    "EG3-072",
    "EG3-073",
    "EG3-074",
    "EG3-075",
    "EG3-076",
    "EG3-077",
    "EG3-078",
    "EG3-079",
    "EG3-080",
    "EG3-081",
    "EG3-082",
    "EG3-083",
    "EG3-084",
    "EG3-085",
    "EG3-086",
    "EG3-087",
    "EG3-088",
    "EG3-089",
    "EG3-090",
    "EG3-091",
    "EG3-092",
    "EG3-093",
    "EG3-094",
    "EG3-095",
    "EG3-096",
    "EG3-097",
    "EG3-098",
    "EG3-099",
    "EG3-100",
    "EG3-101",
    "EG3-102",
    "EG3-103",
    "EG3-104",
    "EG3-105",
    "EG3-106",
    "EG3-107",
    "EG3-108",
    "EG3-109",
    "EG3-110",
    "EG3-111",
    "EG3-112",
    "EG4-000",
    "EG4-001",
    "EG4-002",
    "EG4-003",
    "EG4-004",
    "EG4-005",
    "EG4-006",
    "EG4-007",
    "EG4-008",
    "EG4-009",
    "EG4-010",
    "EG4-011",
    "EG4-012",
    "EG4-013",
    "EG4-014",
    "EG4-015",
    "EG4-016",
    "EG4-017",
    "EG4-018",
    "EG4-019",
    "EG4-020",
    "EG4-021",
    "EG4-022",
    "EG4-023",
    "EG4-024",
    "EG4-025",
    "EG4-026",
    "EG4-027",
    "EG4-028",
    "EG4-029",
    "EG4-030",
    "EG4-031",
    "EG4-032",
    "EG4-033",
    "EG4-034",
    "EG4-035",
    "EG4-036",
    "EG4-037",
    "EG4-038",
    "EG4-039",
    "EG4-040",
    "EG4-041",
    "EG4-042",
    "EG4-043",
    "EG4-044",
    "EG4-045",
    "EG4-046",
    "EG4-047",
    "EG4-048",
    "EG4-049",
    "EG4-050",
    "EG4-051",
    "EG4-052",
    "EG4-053",
    "EG4-054",
    "EG4-055",
    "EG4-056",
    "EG4-057",
    "EG4-058",
    "EG4-059",
    "EG4-060",
    "EG4-061",
    "EG4-062",
    "EG4-063",
    "EG4-064",
    "EG4-065",
    "EG4-066",
    "EG4-067",
    "EG4-068",
    "EG4-069",
    "EG4-070",
    "EG4-071",
    "EG4-072",
    "EG4-073",
    "EG4-074",
    "EG4-075",
    "EG4-076",
    "EG4-077",
    "EG4-078",
    "EG4-079",
    "EG4-080",
    "EG4-081",
    "EG4-082",
    "EG4-083",
    "EG4-084",
    "EG4-085",
    "EG4-086",
    "EG4-087",
    "EG4-088",
    "EG4-089",
    "EG4-090",
    "EG4-091",
    "EG4-092",
    "EG4-093",
    "EG4-094",
    "EG4-095",
    "EG4-096",
    "EG4-097",
    "EG4-098",
    "EG4-099",
    "EG4-100",
    "EG4-101",
    "EG4-102",
    "EG4-103",
    "EG4-104",
    "EG4-105",
    "EG4-106",
    "EG4-107",
    "EG4-108",
    "EG4-109",
    "EG4-110",
    "EG4-111",
    "EG4-112",
  ];

  mongoose.connect(dbUri).then(() => {
    console.log("DB Connected");
    filePaths.forEach((path) => storeFile(path));
  });
};

init();
